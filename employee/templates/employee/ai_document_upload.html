{% extends "index.html" %}
{% load i18n %}
{% load static %}
{% load basefilters %}
{% load horillafilters %}

{% block content %}
<style>
    .ai-upload-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .ai-main-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 30px;
    }
    
    .ai-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
        position: relative;
    }
    
    .ai-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.3;
    }
    
    .ai-header-content {
        position: relative;
        z-index: 1;
    }
    
    .ai-icon {
        font-size: 4rem;
        margin-bottom: 15px;
        display: block;
    }
    
    .ai-title {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .ai-subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 0;
    }
    
    .upload-zone {
        border: 3px dashed #e0e6ed;
        border-radius: 15px;
        padding: 40px 20px;
        text-align: center;
        transition: all 0.3s ease;
        background: #f8f9fa;
        margin: 20px 0;
        position: relative;
        overflow: hidden;
    }
    
    .upload-zone:hover {
        border-color: #667eea;
        background: #f0f4ff;
        transform: translateY(-2px);
    }
    
    .upload-zone.dragover {
        border-color: #667eea;
        background: #e8f2ff;
        transform: scale(1.02);
    }
    
    .upload-icon {
        font-size: 3rem;
        color: #667eea;
        margin-bottom: 20px;
        display: block;
    }
    
    .upload-text {
        font-size: 1.2rem;
        color: #495057;
        margin-bottom: 10px;
        font-weight: 600;
    }
    
    .upload-subtext {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 20px;
    }
    
    .file-input-wrapper {
        position: relative;
        display: inline-block;
    }
    
    .file-input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }
    
    .file-input-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }
    
    .file-input-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }
    
    .document-type-card {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        margin-top: 20px;
    }
    
    .type-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
    }
    
    .type-option {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .type-option:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .type-option.selected {
        border-color: #667eea;
        background: #f0f4ff;
    }
    
    .type-icon {
        font-size: 2rem;
        color: #667eea;
        margin-bottom: 10px;
        display: block;
    }
    
    .type-name {
        font-weight: 600;
        color: #495057;
        margin: 0;
    }
    
    .processing-card {
        background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
        border-radius: 15px;
        padding: 30px;
        text-align: center;
        margin: 20px 0;
        display: none;
    }
    
    .progress-ring {
        width: 80px;
        height: 80px;
        margin: 0 auto 20px;
    }
    
    .progress-ring circle {
        fill: none;
        stroke: #667eea;
        stroke-width: 4;
        stroke-linecap: round;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
    }
    
    .progress-ring .progress-circle {
        stroke-dasharray: 251.2;
        stroke-dashoffset: 251.2;
        transition: stroke-dashoffset 0.3s ease;
    }
    
    .results-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        margin: 20px 0;
        overflow: hidden;
        display: none;
    }
    
    .results-header {
        background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
        color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .field-section {
        border-bottom: 1px solid #e9ecef;
        padding: 25px 30px;
    }
    
    .field-section:last-child {
        border-bottom: none;
    }
    
    .section-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #2d3436;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .field-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .field-item {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        border-left: 4px solid #667eea;
    }
    
    .field-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .confidence-badge {
        background: #667eea;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .field-input {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .field-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .analyses-table {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .table-header {
        background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
        color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .table th {
        background: #f8f9fa;
        padding: 15px 20px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #e9ecef;
    }
    
    .table td {
        padding: 15px 20px;
        border-bottom: 1px solid #e9ecef;
        vertical-align: middle;
    }
    
    .table tbody tr:hover {
        background: #f8f9fa;
    }
    
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-completed {
        background: #d4edda;
        color: #155724;
    }
    
    .status-processing {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-failed {
        background: #f8d7da;
        color: #721c24;
    }
    
    .action-buttons {
        display: flex;
        gap: 8px;
    }
    
    .btn-icon {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-view {
        background: #667eea;
        color: white;
    }
    
    .btn-view:hover {
        background: #5a6fd8;
        transform: translateY(-2px);
    }
    
    .btn-delete {
        background: #e74c3c;
        color: white;
    }
    
    .btn-delete:hover {
        background: #c0392b;
        transform: translateY(-2px);
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }
    
    .empty-icon {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }
    
    .floating-actions {
        position: fixed;
        bottom: 30px;
        right: 30px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        z-index: 1000;
    }
    
    .fab {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .fab:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    
    .fab-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .fab-secondary {
        background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
    }
    
    @media (max-width: 768px) {
        .ai-title {
            font-size: 2rem;
        }
        
        .type-grid {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
        
        .field-grid {
            grid-template-columns: 1fr;
        }
        
        .floating-actions {
            bottom: 20px;
            right: 20px;
        }
        
        .fab {
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
        }
    }
</style>

<div class="ai-upload-container">
    <div class="oh-wrapper">
        <div class="oh-main__inner">
            <!-- Header Section -->
            <div class="ai-main-card">
                <div class="ai-header">
                    <div class="ai-header-content">
                        <ion-icon name="document-text-outline" class="ai-icon"></ion-icon>
                        <h1 class="ai-title">{% trans "AI Document Processing" %}</h1>
                        <p class="ai-subtitle">{% trans "Upload documents to automatically extract employee information" %}</p>
                    </div>
                </div>
                
                <div class="oh-card__body" style="padding: 30px;">
                    <!-- Upload Section -->
                    <form id="document-upload-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- File Upload Zone -->
                        <div class="upload-zone" id="upload-zone">
                            <ion-icon name="cloud-upload-outline" class="upload-icon"></ion-icon>
                            <div class="upload-text">{% trans "Drag & drop your document here" %}</div>
                            <div class="upload-subtext">{% trans "or click to browse files" %}</div>
                            
                            <div class="file-input-wrapper">
                                <input type="file" id="document-file" name="document" class="file-input" 
                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.tiff" required>
                                <button type="button" class="file-input-btn" onclick="document.getElementById('document-file').click()">
                                    <ion-icon name="folder-open-outline"></ion-icon>
                                    {% trans "Choose File" %}
                                </button>
                            </div>
                            
                            <div style="margin-top: 15px; font-size: 0.9rem; color: #6c757d;">
                                <strong>{% trans "Supported formats:" %}</strong> PDF, DOC, DOCX, JPG, PNG, TIFF<br>
                                <strong>{% trans "Maximum size:" %}</strong> 10MB
                            </div>
                        </div>
                        
                        <!-- Document Type Selection -->
                        <div class="document-type-card">
                            <h4 style="margin-bottom: 15px; color: #495057; font-weight: 600;">
                                <ion-icon name="bulb-outline" style="margin-right: 8px; color: #667eea;"></ion-icon>
                                {% trans "Document Type" %}
                            </h4>
                            <div class="type-grid">
                                <div class="type-option" data-type="">
                                    <ion-icon name="search-outline" class="type-icon"></ion-icon>
                                    <p class="type-name">{% trans "Auto-detect" %}</p>
                                </div>
                                <div class="type-option" data-type="resume">
                                    <ion-icon name="person-outline" class="type-icon"></ion-icon>
                                    <p class="type-name">{% trans "Resume/CV" %}</p>
                                </div>
                                <div class="type-option" data-type="aadhaar">
                                    <ion-icon name="card-outline" class="type-icon"></ion-icon>
                                    <p class="type-name">{% trans "Aadhaar Card" %}</p>
                                </div>
                                <div class="type-option" data-type="pan">
                                    <ion-icon name="document-outline" class="type-icon"></ion-icon>
                                    <p class="type-name">{% trans "PAN Card" %}</p>
                                </div>
                                <div class="type-option" data-type="passport">
                                    <ion-icon name="airplane-outline" class="type-icon"></ion-icon>
                                    <p class="type-name">{% trans "Passport Card" %}</p>
                                </div>
                                <div class="type-option" data-type="bank_statement">
                                    <ion-icon name="wallet-outline" class="type-icon"></ion-icon>
                                    <p class="type-name">{% trans "Bank Statement" %}</p>
                                </div>
                                <div class="type-option" data-type="salary_slip">
                                    <ion-icon name="cash-outline" class="type-icon"></ion-icon>
                                    <p class="type-name">{% trans "Salary Slip" %}</p>
                                </div>
                                <div class="type-option" data-type="payslip">
                                    <ion-icon name="receipt-outline" class="type-icon"></ion-icon>
                                    <p class="type-name">{% trans "Payslip" %}</p>
                                </div>
                                <div class="type-option" data-type="contract">
                                    <ion-icon name="contract-outline" class="type-icon"></ion-icon>
                                    <p class="type-name">{% trans "Contract" %}</p>
                                </div>
                                <div class="type-option" data-type="certificate">
                                    <ion-icon name="school-outline" class="type-icon"></ion-icon>
                                    <p class="type-name">{% trans "Certificate" %}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Upload Button -->
                        <div style="text-align: center; margin-top: 30px;">
                            <button type="submit" class="file-input-btn" id="upload-btn" style="padding: 15px 40px; font-size: 1.1rem;">
                                <ion-icon name="cloud-upload-outline"></ion-icon>
                                {% trans "Upload & Process with AI" %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Processing Status -->
            <div class="processing-card" id="processing-card">
                <div class="progress-ring">
                    <svg width="80" height="80">
                        <circle cx="40" cy="40" r="36" stroke="#e9ecef" stroke-width="4"/>
                        <circle cx="40" cy="40" r="36" class="progress-circle" id="progress-circle"/>
                    </svg>
                </div>
                <h3 style="margin-bottom: 10px; color: #2d3436;">{% trans "AI Processing Document" %}</h3>
                <p id="processing-message" style="color: #636e72; margin-bottom: 0;">{% trans "Please wait while we extract information..." %}</p>
            </div>

            <!-- Results -->
            <div class="results-card" id="results-card">
                <div class="results-header">
                    <div>
                        <h3 style="margin: 0; font-size: 1.5rem;">
                            <ion-icon name="checkmark-circle-outline" style="margin-right: 10px;"></ion-icon>
                            {% trans "Extracted Information" %}
                        </h3>
                        <p style="margin: 5px 0 0 0; opacity: 0.9;">{% trans "Review and apply the extracted data" %}</p>
                    </div>
                    <button class="file-input-btn" id="refresh-btn" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">
                        <ion-icon name="refresh-outline"></ion-icon>
                        {% trans "Refresh" %}
                    </button>
                </div>
                <div id="extraction-results">
                    <!-- Results will be loaded here -->
                </div>
            </div>

            <!-- Previous Analyses -->
            <div class="analyses-table" id="analyses-card">
                <div class="table-header">
                    <div>
                        <h3 style="margin: 0; font-size: 1.5rem;">
                            <ion-icon name="time-outline" style="margin-right: 10px;"></ion-icon>
                            {% trans "Previous Analyses" %}
                        </h3>
                        <p style="margin: 5px 0 0 0; opacity: 0.9;">{% trans "View and manage your document processing history" %}</p>
                    </div>
                    <button class="file-input-btn" id="refresh-analyses-btn" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);">
                        <ion-icon name="refresh-outline"></ion-icon>
                        {% trans "Refresh" %}
                    </button>
                </div>
                <div id="analyses-list">
                    <!-- Analyses list will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Buttons -->
<div class="floating-actions">
    <button class="fab fab-secondary" onclick="scrollToTop()" title="{% trans 'Scroll to Top' %}">
        <ion-icon name="arrow-up-outline"></ion-icon>
    </button>
    <button class="fab fab-primary" onclick="document.getElementById('upload-zone').scrollIntoView({behavior: 'smooth'})" title="{% trans 'Upload Document' %}">
        <ion-icon name="cloud-upload-outline"></ion-icon>
    </button>
</div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('document-upload-form');
    const uploadZone = document.getElementById('upload-zone');
    const processingCard = document.getElementById('processing-card');
    const resultsCard = document.getElementById('results-card');
    const analysesCard = document.getElementById('analyses-card');
    const uploadBtn = document.getElementById('upload-btn');
    const progressCircle = document.getElementById('progress-circle');
    const processingMessage = document.getElementById('processing-message');
    
    let currentAnalysisId = null;
    let statusCheckInterval = null;
    let selectedDocumentType = '';

    // Initialize UI
    initializeUI();
    
    // Load previous analyses on page load
    loadAnalyses();

    function initializeUI() {
        // Document type selection
        const typeOptions = document.querySelectorAll('.type-option');
        typeOptions.forEach(option => {
            option.addEventListener('click', function() {
                typeOptions.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                selectedDocumentType = this.dataset.type;
            });
        });
        
        // Set auto-detect as default
        typeOptions[0].classList.add('selected');
        
        // Drag and drop functionality
        uploadZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('document-file').files = files;
                updateFileDisplay(files[0]);
            }
        });
        
        // File input change
        document.getElementById('document-file').addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                updateFileDisplay(e.target.files[0]);
            }
        });
    }
    
    function updateFileDisplay(file) {
        const uploadText = uploadZone.querySelector('.upload-text');
        const uploadSubtext = uploadZone.querySelector('.upload-subtext');
        
        uploadText.textContent = file.name;
        uploadSubtext.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
        uploadZone.style.borderColor = '#667eea';
        uploadZone.style.background = '#f0f4ff';
    }

    // Handle form submission
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('document-file');
        const file = fileInput.files[0];
        
        if (!file) {
            showAlert('Please select a file to upload.', 'error');
            return;
        }

        // Validate file size (10MB)
        if (file.size > 10 * 1024 * 1024) {
            showAlert('File size too large. Maximum size is 10MB.', 'error');
            return;
        }

        uploadDocument(file);
    });

    // Upload document
    function uploadDocument(file) {
        const formData = new FormData();
        formData.append('document', file);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<ion-icon name="hourglass-outline"></ion-icon> {% trans "Uploading..." %}';
        
        showProcessingCard();

        fetch(`/employee/ai/upload/{{ employee_id }}/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentAnalysisId = data.analysis_id;
                processingMessage.textContent = 'Document uploaded successfully. Processing...';
                checkProcessingStatus();
            } else {
                showAlert(data.message, 'error');
                hideProcessingCard();
                resetUploadButton();
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            showAlert('Upload failed. Please try again.', 'error');
            hideProcessingCard();
            resetUploadButton();
        });
    }

    // Check processing status
    function checkProcessingStatus() {
        if (!currentAnalysisId) return;

        fetch(`/employee/ai/analysis/${currentAnalysisId}/status/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const analysis = data.analysis;
                updateProgress(analysis);
                
                if (analysis.status === 'completed') {
                    clearInterval(statusCheckInterval);
                    hideProcessingCard();
                    loadExtractedData();
                    loadAnalyses();
                } else if (analysis.status === 'failed') {
                    clearInterval(statusCheckInterval);
                    hideProcessingCard();
                    showAlert('Document processing failed. Please try again.', 'error');
                    resetUploadButton();
                }
            }
        })
        .catch(error => {
            console.error('Status check error:', error);
        });
    }

    // Update progress bar
    function updateProgress(analysis) {
        const confidence = Math.round(analysis.confidence_score * 100);
        const circumference = 2 * Math.PI * 36; // radius = 36
        const offset = circumference - (confidence / 100) * circumference;
        progressCircle.style.strokeDashoffset = offset;
        processingMessage.textContent = `Processing... (${confidence}% confidence)`;
    }

    // Load extracted data
    function loadExtractedData() {
        if (!currentAnalysisId) return;

        fetch(`/employee/ai/analysis/${currentAnalysisId}/data/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayExtractedData(data.data);
                showResultsCard();
            }
        })
        .catch(error => {
            console.error('Load data error:', error);
        });
    }

    // Display extracted data
    function displayExtractedData(data) {
        const resultsDiv = document.getElementById('extraction-results');
        let html = '';

        // Document info header
        html += `
            <div style="background: #f8f9fa; padding: 20px 30px; border-bottom: 1px solid #e9ecef;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h4 style="margin: 0; color: #2d3436; display: flex; align-items: center; gap: 10px;">
                            <ion-icon name="document-outline" style="color: #667eea;"></ion-icon>
                            ${data.document_type.replace('_', ' ').toUpperCase()}
                        </h4>
                        <p style="margin: 5px 0 0 0; color: #636e72;">{% trans "Document Analysis Results" %}</p>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 2rem; font-weight: 700; color: #667eea; margin-bottom: 5px;">
                            ${Math.round(data.confidence_score * 100)}%
                        </div>
                        <div style="color: #636e72; font-size: 0.9rem;">{% trans "Confidence Score" %}</div>
                    </div>
                </div>
            </div>
        `;

        // Fields by type
        Object.keys(data.fields_by_type).forEach(type => {
            const fields = data.fields_by_type[type];
            if (fields.length > 0) {
                html += `
                    <div class="field-section">
                        <div class="section-title">
                            <ion-icon name="${getTypeIcon(type)}" style="color: #667eea;"></ion-icon>
                            ${getTypeDisplayName(type)}
                        </div>
                        <div class="field-grid">
                `;
                
                fields.forEach(field => {
                    const confidence = Math.round(field.confidence_score * 100);
                    const confidenceClass = confidence >= 80 ? '#00b894' : confidence >= 50 ? '#fdcb6e' : '#e17055';
                    
                    html += `
                        <div class="field-item">
                            <div class="field-label">
                                ${getFieldDisplayName(field.field_name)}
                                <span class="confidence-badge" style="background: ${confidenceClass};">
                                    ${confidence}%
                                </span>
                            </div>
                            <input type="text" class="field-input" value="${field.extracted_value}" 
                                   data-field-id="${field.id}" data-field-type="${type}" 
                                   name="${field.field_name}" data-field-name="${field.field_name}">
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="file-input-btn" onclick="applyFields('${type}')" style="padding: 12px 30px;">
                                <ion-icon name="checkmark-outline"></ion-icon>
                                {% trans "Apply Selected Fields" %}
                            </button>
                        </div>
                    </div>
                `;
            }
        });

        resultsDiv.innerHTML = html;
    }
    
    function getTypeIcon(type) {
        const icons = {
            'personal': 'person-outline',
            'work': 'briefcase-outline',
            'bank': 'wallet-outline',
            'contact': 'call-outline',
            'education': 'school-outline',
            'experience': 'time-outline'
        };
        return icons[type] || 'document-outline';
    }
    
    function getFieldDisplayName(fieldName) {
        const fields = {
            'first_name': '{% trans "First Name" %}',
            'last_name': '{% trans "Last Name" %}',
            'email': '{% trans "Email" %}',
            'phone': '{% trans "Phone" %}',
            'address': '{% trans "Address" %}',
            'city': '{% trans "City" %}',
            'state': '{% trans "State" %}',
            'country': '{% trans "Country" %}',
            'zip_code': '{% trans "ZIP Code" %}',
            'zip': '{% trans "ZIP Code" %}',
            'date_of_birth': '{% trans "Date of Birth" %}',
            'gender': '{% trans "Gender" %}',
            'qualification': '{% trans "Qualification" %}',
            'experience': '{% trans "Experience" %}',
            'experience_years': '{% trans "Experience" %}',
            'marital_status': '{% trans "Marital Status" %}',
            'emergency_contact': '{% trans "Emergency Contact" %}',
            'emergency_contact_name': '{% trans "Emergency Contact Name" %}',
            'emergency_contact_relation': '{% trans "Emergency Contact Relation" %}',
            'aadhaar_number': '{% trans "Aadhaar Number" %}',
            'pan_number': '{% trans "PAN Number" %}',
            'passport_number': '{% trans "Passport Number" %}',
            'passport_expiry': '{% trans "Passport Expiry" %}',
            'passport_issue_date': '{% trans "Passport Issue Date" %}',
            'nationality': '{% trans "Nationality" %}',
            'driving_license': '{% trans "Driving License" %}',
            'work_email': '{% trans "Work Email" %}',
            'work_phone': '{% trans "Work Phone" %}',
            'work_location': '{% trans "Work Location" %}',
            'job_title': '{% trans "Job Title" %}',
            'job_position': '{% trans "Job Position" %}',
            'job_role': '{% trans "Job Role" %}',
            'department': '{% trans "Department" %}',
            'company': '{% trans "Company" %}',
            'joining_date': '{% trans "Joining Date" %}',
            'contract_end_date': '{% trans "Contract End Date" %}',
            'basic_salary': '{% trans "Basic Salary" %}',
            'salary_per_hour': '{% trans "Salary Per Hour" %}',
            'experience_years': '{% trans "Experience Years" %}',
            'shift': '{% trans "Shift" %}',
            'work_type': '{% trans "Work Type" %}',
            'employee_type': '{% trans "Employee Type" %}',
            'employee_tag': '{% trans "Employee Tag" %}',
            'skills': '{% trans "Skills" %}',
            'qualifications': '{% trans "Qualifications" %}',
            'reporting_manager': '{% trans "Reporting Manager" %}',
            'bank_name': '{% trans "Bank Name" %}',
            'account_number': '{% trans "Account Number" %}',
            'ifsc_code': '{% trans "IFSC Code" %}',
            'branch': '{% trans "Branch" %}',
            'bank_address': '{% trans "Bank Address" %}',
            'bank_city': '{% trans "Bank City" %}',
            'bank_state': '{% trans "Bank State" %}',
            'bank_country': '{% trans "Bank Country" %}',
            'account_type': '{% trans "Account Type" %}',
            // Additional Payslip fields
            'hra': '{% trans "HRA" %}',
            'total_earnings': '{% trans "Total Earnings" %}',
            'net_pay': '{% trans "Net Pay" %}',
            'pf_number': '{% trans "PF Number" %}',
            'pf_uan': '{% trans "PF UAN" %}',
            'pf_contribution_percentage': '{% trans "PF Contribution %" %}',
            'pf_voluntary_contribution': '{% trans "PF Voluntary Contribution" %}',
            'pf_nominee_name': '{% trans "PF Nominee Name" %}',
            'pf_nominee_relation': '{% trans "PF Nominee Relation" %}',
            'esi_number': '{% trans "ESI Number" %}',
            'esi_contribution_percentage': '{% trans "ESI Contribution %" %}',
            'esi_family_members': '{% trans "ESI Family Members" %}',
            'esi_dispensary_code': '{% trans "ESI Dispensary Code" %}',
            'pt_number': '{% trans "Professional Tax Number" %}',
            'pt_state': '{% trans "Professional Tax State" %}',
            'pt_deduction_amount': '{% trans "Professional Tax Deduction Amount" %}',
            'lwf_number': '{% trans "Labour Welfare Fund Number" %}',
            'lwf_state': '{% trans "Labour Welfare Fund State" %}',
            'lwf_deduction_amount': '{% trans "Labour Welfare Fund Deduction Amount" %}',
            'certificate_name': '{% trans "Certificate Name" %}',
            'institution': '{% trans "Institution" %}',
            'course_name': '{% trans "Course Name" %}',
            'completion_date': '{% trans "Completion Date" %}',
            'grade_percentage': '{% trans "Grade/Percentage" %}',
            'duration': '{% trans "Duration" %}',
            'specialization': '{% trans "Specialization" %}',
            'issuing_authority': '{% trans "Issuing Authority" %}',
            'certificate_number': '{% trans "Certificate Number" %}',
            'validity_period': '{% trans "Validity Period" %}',
            'skills_learned': '{% trans "Skills Learned" %}'
        };
        return fields[fieldName] || fieldName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    // Load analyses list
    function loadAnalyses() {
        fetch(`/employee/ai/employee/{{ employee_id }}/analyses/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayAnalyses(data.analyses);
            }
        })
        .catch(error => {
            console.error('Load analyses error:', error);
        });
    }

    // Display analyses list
    function displayAnalyses(analyses) {
        const analysesDiv = document.getElementById('analyses-list');
        
        if (analyses.length === 0) {
            analysesDiv.innerHTML = `
                <div class="empty-state">
                    <ion-icon name="document-outline" class="empty-icon"></ion-icon>
                    <h4>{% trans "No analyses found" %}</h4>
                    <p>{% trans "Upload your first document to get started with AI processing" %}</p>
                </div>
            `;
            return;
        }

        let html = '<table class="table">';
        html += `
            <thead>
                <tr>
                    <th>{% trans "Document Type" %}</th>
                    <th>{% trans "Status" %}</th>
                    <th>{% trans "Confidence" %}</th>
                    <th>{% trans "Fields" %}</th>
                    <th>{% trans "Date" %}</th>
                    <th>{% trans "Actions" %}</th>
                </tr>
            </thead>
            <tbody>
        `;

        analyses.forEach(analysis => {
            const confidence = Math.round(analysis.confidence_score * 100);
            const statusClass = analysis.status === 'completed' ? 'status-completed' : 
                              analysis.status === 'failed' ? 'status-failed' : 'status-processing';
            
            html += `
                <tr>
                    <td style="font-weight: 600; color: #2d3436;">${analysis.document_type}</td>
                    <td><span class="status-badge ${statusClass}">${analysis.status}</span></td>
                    <td style="font-weight: 600; color: #667eea;">${confidence}%</td>
                    <td style="color: #636e72;">${analysis.fields_count}</td>
                    <td style="color: #636e72;">${analysis.created_at}</td>
                    <td>
                        <div class="action-buttons">
                            <button type="button" class="btn-icon btn-view" onclick="viewAnalysis(${analysis.id})" title="{% trans 'View Details' %}">
                                <ion-icon name="eye-outline"></ion-icon>
                            </button>
                            <button type="button" class="btn-icon btn-delete" data-analysis-id="${analysis.id}" title="{% trans 'Delete' %}">
                                <ion-icon name="trash-outline"></ion-icon>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table>';
        analysesDiv.innerHTML = html;
        
        // Add event listeners for delete buttons
        const deleteButtons = analysesDiv.querySelectorAll('.btn-delete');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                const analysisId = this.getAttribute('data-analysis-id');
                if (analysisId) {
                    deleteAnalysisById(analysisId);
                }
            });
        });
    }
    
    // Scroll to top function
    window.scrollToTop = function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // Show/hide cards
    function showProcessingCard() {
        processingCard.style.display = 'block';
        resultsCard.style.display = 'none';
        // Scroll to processing card
        processingCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function hideProcessingCard() {
        processingCard.style.display = 'none';
    }

    function showResultsCard() {
        resultsCard.style.display = 'block';
        // Scroll to results card
        resultsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function resetUploadButton() {
        uploadBtn.disabled = false;
        uploadBtn.innerHTML = '<ion-icon name="cloud-upload-outline"></ion-icon> {% trans "Upload & Process with AI" %}';
    }
    
    function showAlert(message, type = 'info') {
        // Create a modern alert notification
        const alertDiv = document.createElement('div');
        alertDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? '#e74c3c' : type === 'success' ? '#00b894' : '#667eea'};
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            font-weight: 600;
            max-width: 300px;
            animation: slideIn 0.3s ease;
        `;
        
        alertDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <ion-icon name="${type === 'error' ? 'close-circle' : type === 'success' ? 'checkmark-circle' : 'information-circle'}-outline"></ion-icon>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            alertDiv.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 300);
        }, 5000);
    }
    
    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    // Utility functions
    function getTypeDisplayName(type) {
        const types = {
            'personal': '{% trans "Personal Information" %}',
            'work': '{% trans "Work Information" %}',
            'bank': '{% trans "Bank Information" %}',
            'contact': '{% trans "Contact Information" %}',
            'education': '{% trans "Education Information" %}',
            'experience': '{% trans "Experience Information" %}'
        };
        return types[type] || type;
    }

    function getFieldDisplayName(fieldName) {
        const fields = {
            'first_name': '{% trans "First Name" %}',
            'last_name': '{% trans "Last Name" %}',
            'email': '{% trans "Email" %}',
            'phone': '{% trans "Phone" %}',
            'address': '{% trans "Address" %}',
            'city': '{% trans "City" %}',
            'state': '{% trans "State" %}',
            'country': '{% trans "Country" %}',
            'zip_code': '{% trans "ZIP Code" %}',
            'zip': '{% trans "ZIP Code" %}',
            'date_of_birth': '{% trans "Date of Birth" %}',
            'gender': '{% trans "Gender" %}',
            'qualification': '{% trans "Qualification" %}',
            'experience': '{% trans "Experience" %}',
            'experience_years': '{% trans "Experience" %}',
            'marital_status': '{% trans "Marital Status" %}',
            'emergency_contact': '{% trans "Emergency Contact" %}',
            'emergency_contact_name': '{% trans "Emergency Contact Name" %}',
            'emergency_contact_relation': '{% trans "Emergency Contact Relation" %}',
            'aadhaar_number': '{% trans "Aadhaar Number" %}',
            'pan_number': '{% trans "PAN Number" %}',
            'passport_number': '{% trans "Passport Number" %}',
            'passport_expiry': '{% trans "Passport Expiry" %}',
            'passport_issue_date': '{% trans "Passport Issue Date" %}',
            'nationality': '{% trans "Nationality" %}',
            'driving_license': '{% trans "Driving License" %}',
            'work_email': '{% trans "Work Email" %}',
            'work_phone': '{% trans "Work Phone" %}',
            'work_location': '{% trans "Work Location" %}',
            'job_title': '{% trans "Job Title" %}',
            'job_position': '{% trans "Job Position" %}',
            'job_role': '{% trans "Job Role" %}',
            'department': '{% trans "Department" %}',
            'company': '{% trans "Company" %}',
            'joining_date': '{% trans "Joining Date" %}',
            'contract_end_date': '{% trans "Contract End Date" %}',
            'basic_salary': '{% trans "Basic Salary" %}',
            'salary_per_hour': '{% trans "Salary Per Hour" %}',
            'experience_years': '{% trans "Experience Years" %}',
            'shift': '{% trans "Shift" %}',
            'work_type': '{% trans "Work Type" %}',
            'employee_type': '{% trans "Employee Type" %}',
            'employee_tag': '{% trans "Employee Tag" %}',
            'skills': '{% trans "Skills" %}',
            'qualifications': '{% trans "Qualifications" %}',
            'reporting_manager': '{% trans "Reporting Manager" %}',
            'bank_name': '{% trans "Bank Name" %}',
            'account_number': '{% trans "Account Number" %}',
            'ifsc_code': '{% trans "IFSC Code" %}',
            'branch': '{% trans "Branch" %}',
            'bank_address': '{% trans "Bank Address" %}',
            'bank_city': '{% trans "Bank City" %}',
            'bank_state': '{% trans "Bank State" %}',
            'bank_country': '{% trans "Bank Country" %}',
            'account_type': '{% trans "Account Type" %}',
            // Additional Payslip fields
            'hra': '{% trans "HRA" %}',
            'total_earnings': '{% trans "Total Earnings" %}',
            'net_pay': '{% trans "Net Pay" %}',
            'pf_number': '{% trans "PF Number" %}',
            'pf_uan': '{% trans "PF UAN" %}',
            'pf_contribution_percentage': '{% trans "PF Contribution %" %}',
            'pf_voluntary_contribution': '{% trans "PF Voluntary Contribution" %}',
            'pf_nominee_name': '{% trans "PF Nominee Name" %}',
            'pf_nominee_relation': '{% trans "PF Nominee Relation" %}',
            'esi_number': '{% trans "ESI Number" %}',
            'esi_contribution_percentage': '{% trans "ESI Contribution %" %}',
            'esi_family_members': '{% trans "ESI Family Members" %}',
            'esi_dispensary_code': '{% trans "ESI Dispensary Code" %}',
            'pt_number': '{% trans "Professional Tax Number" %}',
            'pt_state': '{% trans "Professional Tax State" %}',
            'pt_deduction_amount': '{% trans "Professional Tax Deduction Amount" %}',
            'lwf_number': '{% trans "Labour Welfare Fund Number" %}',
            'lwf_state': '{% trans "Labour Welfare Fund State" %}',
            'lwf_deduction_amount': '{% trans "Labour Welfare Fund Deduction Amount" %}'
        };
        return fields[fieldName] || fieldName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }


    // Global functions for buttons
    window.applyFields = function(type) {
        const fields = document.querySelectorAll(`input[data-field-type="${type}"]`);
        const selectedFields = [];
        
        console.log('Apply fields called for type:', type);
        console.log('Found fields:', fields);
        
        fields.forEach(input => {
            console.log('Processing input:', input);
            console.log('Input value:', input.value);
            console.log('Input dataset:', input.dataset);
            console.log('Input name:', input.name);
            
            if (input.value.trim()) {
                const fieldData = {
                    field_id: input.dataset.fieldId,
                    field_name: input.name || input.dataset.fieldName,
                    field_type: type,
                    extracted_value: input.value
                };
                console.log('Adding field data:', fieldData);
                selectedFields.push(fieldData);
            }
        });

        console.log('Selected fields to send:', selectedFields);

        if (selectedFields.length === 0) {
            showAlert('Please select at least one field to apply.', 'warning');
            return;
        }

        console.log('Sending request to:', `/employee/ai/analysis/${currentAnalysisId}/data/`);
        console.log('Request body:', JSON.stringify({ selected_fields: selectedFields }));

        fetch(`/employee/ai/analysis/${currentAnalysisId}/data/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ selected_fields: selectedFields })
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                showAlert(data.message, 'success');
                loadAnalyses();
            } else {
                showAlert(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Apply fields error:', error);
            showAlert('Failed to apply fields. Please try again.', 'error');
        });
    };

    window.viewAnalysis = function(analysisId) {
        currentAnalysisId = analysisId;
        loadExtractedData();
        showResultsCard();
    };

    // New robust delete function with custom confirmation
    function deleteAnalysisById(analysisId) {
        console.log('Delete function called with ID:', analysisId);
        console.log('Current page URL:', window.location.href);
        console.log('Page content before delete:', document.body.innerHTML.length);
        
        // Use custom confirmation dialog instead of browser confirm()
        showCustomConfirmDialog(
            '{% trans "Delete Analysis" %}',
            '{% trans "Are you sure you want to delete this analysis? This action cannot be undone." %}',
            function() {
                console.log('User confirmed deletion for analysis ID:', analysisId);
                console.log('Page content after confirm:', document.body.innerHTML.length);
                
                // Show loading state
                const deleteButton = document.querySelector(`[data-analysis-id="${analysisId}"]`);
                if (deleteButton) {
                    deleteButton.disabled = true;
                    deleteButton.innerHTML = '<ion-icon name="hourglass-outline"></ion-icon>';
                }
                
                // Try multiple approaches
                tryDeleteWithFetch(analysisId, deleteButton);
            },
            function() {
                console.log('User cancelled deletion');
            }
        );
    }
    
    // Custom confirmation dialog function
    function showCustomConfirmDialog(title, message, onConfirm, onCancel) {
        // Create modal overlay
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        
        // Create modal dialog
        const dialog = document.createElement('div');
        dialog.style.cssText = `
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
        `;
        
        dialog.innerHTML = `
            <div style="font-size: 1.5rem; margin-bottom: 15px; color: #e74c3c;">
                <ion-icon name="warning-outline"></ion-icon>
            </div>
            <h3 style="margin: 0 0 15px 0; color: #2d3436;">${title}</h3>
            <p style="margin: 0 0 25px 0; color: #636e72; line-height: 1.5;">${message}</p>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button id="confirm-cancel" style="
                    background: #6c757d;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 14px;
                ">{% trans "Cancel" %}</button>
                <button id="confirm-ok" style="
                    background: #e74c3c;
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 14px;
                ">{% trans "Delete" %}</button>
            </div>
        `;
        
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
        
        // Add event listeners
        document.getElementById('confirm-ok').addEventListener('click', function() {
            document.body.removeChild(overlay);
            onConfirm();
        });
        
        document.getElementById('confirm-cancel').addEventListener('click', function() {
            document.body.removeChild(overlay);
            onCancel();
        });
        
        // Close on overlay click
        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) {
                document.body.removeChild(overlay);
                onCancel();
            }
        });
    }
    
    function tryDeleteWithFetch(analysisId, deleteButton) {
        console.log('Attempting DELETE with fetch...');
        
        fetch(`/employee/ai/analysis/${analysisId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            console.log('Delete response status:', response.status);
            console.log('Delete response headers:', response.headers);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Delete response data:', data);
            console.log('Page content after response:', document.body.innerHTML.length);
            if (data.success) {
                console.log('Delete successful, showing alert and reloading analyses');
                showAlert(data.message, 'success');
                console.log('About to call loadAnalyses()');
                loadAnalyses();
                console.log('loadAnalyses() called');
            } else {
                console.log('Delete failed:', data.message);
                showAlert(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Fetch delete failed:', error);
            console.log('Page content after error:', document.body.innerHTML.length);
            showAlert('Failed to delete analysis. Please try again.', 'error');
        })
        .finally(() => {
            // Reset button state
            if (deleteButton) {
                deleteButton.disabled = false;
                deleteButton.innerHTML = '<ion-icon name="trash-outline"></ion-icon>';
            }
        });
    }
    

    // Keep the old function for backward compatibility
    window.deleteAnalysis = function(analysisId, event) {
        console.log('Old delete function called - redirecting to new function');
        deleteAnalysisById(analysisId);
    };
    
    // Test function to check if the issue is with the delete function
    window.testDelete = function() {
        console.log('Test delete function called');
        console.log('Page content length:', document.body.innerHTML.length);
        console.log('Current URL:', window.location.href);
        alert('Test delete function works - page content length: ' + document.body.innerHTML.length);
    };

    // Refresh buttons
    document.getElementById('refresh-btn').addEventListener('click', function() {
        if (currentAnalysisId) {
            loadExtractedData();
        }
    });

    document.getElementById('refresh-analyses-btn').addEventListener('click', function() {
        loadAnalyses();
    });
});
</script>
{% endblock %}

